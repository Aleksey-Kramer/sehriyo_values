<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Результаты голосования по ценностям</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrapper">
    <div class="card results-card">
        <!-- Верхний "слайдер" -->
        <div class="results-header">
            <!-- Пирог — активен по умолчанию -->
            <div class="results-header-tile results-header-tile--left results-header-tile--active" data-mode="pie">
                <img src="img/icon_Pie.svg" alt="Диаграмма-пирог" class="results-header-icon">
            </div>
            <!-- Столбцы -->
            <div class="results-header-tile results-header-tile--right" data-mode="bar">
                <img src="img/icon_Column.svg" alt="Столбчатая диаграмма" class="results-header-icon">
            </div>
        </div>

        <!-- Режим: столбцы -->
        <div id="mode-bar" class="results-mode">
            <div class="results-chart-area">
                <canvas id="valuesChart"></canvas>
            </div>
        </div>

        <!-- Режим: пирог -->
        <div id="mode-pie" class="results-mode">
            <div class="pie-container">
                <!-- Левая колонка легенды -->
                <div class="pie-legend-column pie-legend-column--left">
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-5">
                            <span data-value-id="5">0%</span>
                        </div>
                        <div class="pie-legend-label">Уважение</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-4">
                            <span data-value-id="4">0%</span>
                        </div>
                        <div class="pie-legend-label">Счастье</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-3">
                            <span data-value-id="3">0%</span>
                        </div>
                        <div class="pie-legend-label">Творчество</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-2">
                            <span data-value-id="2">0%</span>
                        </div>
                        <div class="pie-legend-label">Самореализация</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-1">
                            <span data-value-id="1">0%</span>
                        </div>
                        <div class="pie-legend-label">Саморазвитие</div>
                    </div>
                </div>

                <!-- Центр с логотипом и кольцом -->
                <div class="pie-center">
                    <div class="pie-chart-wrapper">
                        <canvas id="pieChart"></canvas>
                        <img src="img/logo.png" alt="Sehriyo" class="pie-logo">
                    </div>
                </div>

                <!-- Правая колонка легенды -->
                <div class="pie-legend-column pie-legend-column--right">
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-6">
                            <span data-value-id="6">0%</span>
                        </div>
                        <div class="pie-legend-label">Командность</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-7">
                            <span data-value-id="7">0%</span>
                        </div>
                        <div class="pie-legend-label">Ответственность</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-8">
                            <span data-value-id="8">0%</span>
                        </div>
                        <div class="pie-legend-label">Современность</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-9">
                            <span data-value-id="9">0%</span>
                        </div>
                        <div class="pie-legend-label">Эстетика и красота</div>
                    </div>
                    <div class="pie-legend-row">
                        <div class="pie-legend-color value-color-10">
                            <span data-value-id="10">0%</span>
                        </div>
                        <div class="pie-legend-label">Забота о ребёнке</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorBox" class="error" style="display:none;text-align:center;margin-top:8px;">
            Ошибка загрузки данных.
        </div>
    </div>
</div>

<script>
    (function () {
        const barCanvas = document.getElementById('valuesChart');
        const pieCanvas = document.getElementById('pieChart');

        // если вдруг canvas не нашёлся — аккуратно выходим
        if (!barCanvas || !pieCanvas) return;

        const barCtx = barCanvas.getContext('2d');
        const pieCtx = pieCanvas.getContext('2d');
        const errorBox = document.getElementById('errorBox');

        const modeBar = document.getElementById('mode-bar');
        const modePie = document.getElementById('mode-pie');
        const headerTiles = document.querySelectorAll('.results-header-tile');

        let barChart = null;
        let pieChart = null;
        let lastLabels = [];
        let lastData = [];
        let lastPercents = [];

        const rootStyles = getComputedStyle(document.documentElement);
        const ALL_COLORS = [
            rootStyles.getPropertyValue('--value-1').trim(),
            rootStyles.getPropertyValue('--value-2').trim(),
            rootStyles.getPropertyValue('--value-3').trim(),
            rootStyles.getPropertyValue('--value-4').trim(),
            rootStyles.getPropertyValue('--value-5').trim(),
            rootStyles.getPropertyValue('--value-6').trim(),
            rootStyles.getPropertyValue('--value-7').trim(),
            rootStyles.getPropertyValue('--value-8').trim(),
            rootStyles.getPropertyValue('--value-9').trim(),
            rootStyles.getPropertyValue('--value-10').trim()
        ];

        const percentagePlugin = {
            id: 'percentagePlugin',
            afterDatasetsDraw(chart) {
                const dataset = chart.data.datasets[0];
                const meta = chart.getDatasetMeta(0);
                const percents = dataset._percents;
                if (!percents || !meta || !meta.data) return;

                const ctx = chart.ctx;
                ctx.save();
                ctx.font = 'bold 16px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';

                meta.data.forEach((bar, index) => {
                    const p = percents[index];
                    if (p == null) return;

                    const text = p + '%';
                    const x = bar.x;
                    const y = bar.base - 4;

                    ctx.fillStyle = '#ffffff';
                    ctx.shadowColor = 'rgba(0,0,0,0.35)';
                    ctx.shadowBlur = 4;
                    ctx.fillText(text, x, y);
                });

                ctx.restore();
            }
        };

        Chart.register(percentagePlugin);

        function setMode(mode) {
            // на всякий случай проверяем существование блоков
            if (!modeBar || !modePie) return;

            headerTiles.forEach(tile =>
                tile.classList.toggle(
                    'results-header-tile--active',
                    tile.dataset.mode === mode
                )
            );

            if (mode === 'bar') {
                modeBar.classList.add('results-mode--active');
                modePie.classList.remove('results-mode--active');
            } else {
                modePie.classList.add('results-mode--active');
                modeBar.classList.remove('results-mode--active');
            }
        }

        headerTiles.forEach(tile => {
            tile.addEventListener('click', function () {
                const mode = tile.dataset.mode || 'bar';
                setMode(mode);
            });
        });

        function renderBarChart(labels, data, percents) {
            if (barChart) {
                barChart.destroy();
            }

            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ALL_COLORS,
                        borderColor: ALL_COLORS,
                        borderWidth: 0,
                        _percents: percents
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            border: {
                                display: true,
                                color: '#d4d4d4',
                                width: 4
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0,
                                padding: 6,
                                font: {
                                    size: 14,
                                    weight: '600'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            display: false,
                            grid: {
                                display: false
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label(context) {
                                    const value = context.parsed.y;
                                    const p = percents[context.dataIndex] ?? 0;
                                    return ' ' + value + ' голос(ов) — ' + p + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderPieChart(data) {
            if (pieChart) {
                pieChart.destroy();
            }

            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: lastLabels,
                    datasets: [{
                        data: data,
                        backgroundColor: ALL_COLORS,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '62%',
                    rotation: -90,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label(context) {
                                    const value = context.parsed;
                                    const p = lastPercents[context.dataIndex] ?? 0;
                                    return ' ' + value + ' голос(ов) — ' + p + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePieLegend(percents) {
            const els = document.querySelectorAll('.pie-legend-color span[data-value-id]');
            els.forEach(span => {
                const id = Number(span.dataset.valueId);
                const p = percents[id - 1] ?? 0;
                span.textContent = p + '%';
            });
        }

        function fetchData() {
            fetch('api/result.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(json => {
                    if (!json || json.success !== true) {
                        throw new Error('Некорректный ответ API');
                    }

                    const labels = json.labels || [];
                    const data = (json.data || []).map(v => Number(v) || 0);

                    if (!labels.length) {
                        throw new Error('Пустые данные');
                    }

                    const total = data.reduce((sum, v) => sum + v, 0);
                    const percents = data.map(v =>
                        total > 0 ? Math.round((v / total) * 100) : 0
                    );

                    lastLabels = labels;
                    lastData = data;
                    lastPercents = percents;

                    renderBarChart(labels, data, percents);
                    renderPieChart(data);
                    updatePieLegend(percents);
                })
                .catch(err => {
                    console.error(err);
                    errorBox.style.display = 'block';
                });
        }

        // Пирог — стартовый режим
        setMode('pie');
        fetchData();
    })();
</script>
</body>
</html>
